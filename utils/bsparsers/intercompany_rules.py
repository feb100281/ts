# intercompany_rules.py
from __future__ import annotations

from typing import Dict, Iterable, Union
import pandas as pd

PatternValue = Union[str, Iterable[str]]
RulesDict = Dict[str, PatternValue]


# --- правила  ---

INTERCOMPANY_EXCLUDE = {
"2024-11-19": 'Перевод средств в связи с окончанием договора N Б/Н от 14.11.2024 ООО "Трендсеттер" по вх.д. 850343 от 19.11.2024',
'2024-10-02': 'Перевод средств в связи с окончанием договора N Б/Н от 25.09.2024 ООО "Трендсеттер" по вх.д. 788752 от 02.10.2024',
'2024-05-13': 'Возврат суммы депозита по депозитному договору № БВ-Ю-810/1100-90618308/5-24 от 08.05.24. Без НДС по вх.д. 4507 от 13.05.2024',
'2024-04-23': 'Возврат суммы депозита по депозитному договору № БВ-Ю-810/1100-90618308/4-24 от 19.04.24. Без НДС по вх.д. 25735 от 23.04.2024',
'2024-03-25': 'Возврат суммы депозита по депозитному договору № БВ-Ю-810/1100-90618308/3-24 от 22.03.24. Без НДС по вх.д. 22217 от 25.03.2024',
'2024-03-18': 'Возврат суммы депозита по депозитному договору № БВ-Ю-810/1100-90618308/2-24 от 15.03.24. Без НДС по вх.д. 3169 от 18.03.2024',
'2024-03-11': 'Возврат суммы депозита по депозитному договору № БВ-Ю-810/1100-90618308/1-24 от 07.03.24. Без НДС по вх.д. 7018 от 11.03.2024',
'2024-01-31': 'Перевод средств в связи с окончанием договора N Б/Н от 15.01.2024 ООО "Трендсеттер" по вх.д. 603079 от 31.01.2024',
'2024-01-10': 'Перевод средств в связи с окончанием договора N Б/Н от 29.12.2023 ООО "Трендсеттер" по вх.д. 594376 от 10.01.2024',
'2024-11-14': 'Зачисление на счет договора банковского депозита №Б/Н от 14.11.2024 ООО "Трендсеттер" Без НДС. по вх.д. 842746 от 14.11.2024',
'2024-09-25': 'Зачисление на счет по договору банковского депозита№ Б/Н от 25.09.2024 ООО "Трендсеттер". НДС не облагается по вх.д. 778730 от 25.09.2024',
'2024-05-08': 'Перевод средств на депозитный счет по договору №БВ-Ю-810/1100-90618308/5-24 от 08.05.2024г., НДС не облагается. по вх.д. 45412 от 08.05.2024',
'2024-04-19': 'Перевод средств на депозитный счет по договору №БВ-Ю-810/1100-90618308/4-24 от 19.04.2024г., НДС не облагается. по вх.д. 64739 от 19.04.2024',
'2024-03-22': 'Перевод средств на депозитный счет по договору №БВ-Ю-810/1100-90618308/3-24 от 22.03.2024г., НДС не облагается. по вх.д. 71267 от 22.03.2024',
'2024-03-15': 'Перевод средств на депозитный счет по договору №БВ-Ю-810/1100-90618308/2-24 от 15.03.2024г., НДС не облагается. по вх.д. 86931 от 15.03.2024',
'2024-03-07': 'Перевод средств на депозитный счет по договору №БВ-Ю-810/1100-90618308/1-24 от 07.03.2024г., НДС не облагается. по вх.д. 56739 от 07.03.2024',
'2024-01-15': 'Зачисление на счет по депозитному договору Б/Н от 15.01.2024 ООО "Трендсеттер" Без НДС по вх.д. 597164 от 15.01.2024',

}

INTERCOMPANY_INCLUDE = {
    "2025-07-05": "Alfa Iss по чеку 04.07.25,2E26AM.НДС не обл.",
    "2025-07-04": '2200+5183 Внес.ср.ООО "ТРЕНДСЕТТЕР" ч-з ТУ 212724(чек 04.07.25 4U88XK) на сч.40702810802430004523 НДС не обл.',
    "2025-07-03": "возврат п/п №247",
}


# --- утилиты ---

def _norm(s: object) -> str:
    """Нормализуем текст для устойчивого сравнения."""
    if s is None:
        return ""
    return " ".join(str(s).replace("\xa0", " ").replace("\n", " ").lower().split())


def _as_list(x: PatternValue) -> list[str]:
    if x is None:
        return []
    if isinstance(x, str):
        return [x]
    return [str(v) for v in x if v is not None]


def apply_intercompany_overrides(
    df: pd.DataFrame,
    *,
    exclude: RulesDict | None = None,
    include: RulesDict | None = None,
    date_col: str = "date",
    text_col: str = "temp",
    target_col: str = "intercompany",
) -> pd.DataFrame:
    """
    Универсальная функция:
    - exclude: совпало (дата + фрагмент) -> intercompany=False
    - include: совпало (дата + фрагмент) -> intercompany=True
    Важно: include применяется ПОСЛЕ exclude (include имеет приоритет).

    df[date_col] должен быть datetime64.
    """
    if df is None or df.empty:
        return df

    exclude = exclude or {}
    include = include or {}

    # если нет колонок — тихо выходим (чтобы не падать в проде)
    for c in (date_col, text_col, target_col):
        if c not in df.columns:
            return df

    # служебные колонки
    date_key = df[date_col].dt.strftime("%Y-%m-%d")
    temp_norm = df[text_col].map(_norm)

    # EXCLUDE -> False
    for d, patterns in exclude.items():
        if not patterns:
            continue
        mask_date = date_key.eq(d)
        for p in map(_norm, _as_list(patterns)):
            if not p:
                continue
            mask_hit = mask_date & temp_norm.str.contains(p, na=False)
            df.loc[mask_hit, target_col] = False

    # INCLUDE -> True (приоритет)
    for d, patterns in include.items():
        if not patterns:
            continue
        mask_date = date_key.eq(d)
        for p in map(_norm, _as_list(patterns)):
            if not p:
                continue
            mask_hit = mask_date & temp_norm.str.contains(p, na=False)
            df.loc[mask_hit, target_col] = True

    return df
