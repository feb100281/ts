{# templates/admin/macro/keyrate/change_list.html #}
{% extends "admin/change_list.html" %}
{% load admin_urls %}
{% load static %}

{# —É–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ breadcrumbs –∏ object-tools #}
{% block breadcrumbs %}{% endblock %}
{% block object-tools %}{% endblock %}

{% block title %}–ú–∞–∫—Ä–æ | –ö–ª—é—á–µ–≤—ã–µ —Å—Ç–∞–≤–∫–∏{% endblock %}

{% block content_title %}
  {% url cl.opts|admin_urlname:'add' as add_url %}

  {# –í–ï–†–•–ù–Ø–Ø –®–ê–ü–ö–ê: –ò–ù–§–û + –î–ï–ô–°–¢–í–ò–Ø #}
  <div style="display:flex; align-items:flex-start; gap:16px; flex-wrap:wrap; padding-bottom:6px;">

    {# –õ–ï–í–ê–Ø –ß–ê–°–¢–¨: –∞–≤–∞—Ç–∞—Ä + —Ç–µ–∫—Å—Ç #}
    <div style="display:flex; align-items:flex-start; gap:12px; flex-wrap:wrap;">

      {# –ê–≤–∞—Ç–∞—Ä –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏ ‚Äî –∫–≤–∞–¥—Ä–∞—Ç, –∫–∞–∫ —É –ò–ü–¶ #}
      <div style="
          width:40px;
          height:40px;
          border-radius:6px;
          background:#eff6ff;
          color:#1d4ed8;
          display:flex;
          align-items:center;
          justify-content:center;
          font-size:20px;
          font-weight:600;
          box-shadow:0 0 0 1px rgba(15,23,42,.12);
      ">
        üìâ
      </div>

      {# –¢–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ #}
      <div style="display:flex; flex-direction:column; gap:4px; line-height:1.3;">

        <span style="
            font-size:11px;
            text-transform:uppercase;
            letter-spacing:0.06em;
            color:#6b7280;
        ">
          –ú–∞–∫—Ä–æ–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
        </span>

        <span style="font-size:19px; font-weight:600; color:#111827;">
          –ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –ë–∞–Ω–∫–∞ –†–æ—Å—Å–∏–∏
        </span>

        <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:2px;">

          {# –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π #}
          <span style="
              font-size:11px;
              padding:2px 8px;
              border-radius:6px;
              background:#dbeafe;
              color:#1d4ed8;
              font-weight:600;
          ">
            –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {{ cl.result_count }}
          </span>

          {# –¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞ #}
          {% if current_rate and current_rate_date %}
            <span style="
                font-size:11px;
                padding:2px 8px;
                border-radius:6px;
                background:#eff6ff;
                color:#1e40af;
                font-weight:500;
                display:inline-flex;
                align-items:center;
                gap:4px;
            ">
              üìå –¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞
              <span style="opacity:.8;">
                –æ—Ç {{ current_rate_date|date:"d.m.Y" }}:
              </span>
              <span style="font-weight:700;">
                {{ current_rate }}%
              </span>
            </span>
          {% elif current_rate %}
            <span style="
                font-size:11px;
                padding:2px 8px;
                border-radius:6px;
                background:#eff6ff;
                color:#1e40af;
                font-weight:500;
            ">
              üìå –¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: {{ current_rate }}%
            </span>
          {% endif %}

          {# Œî –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Ä–µ—à–µ–Ω–∏—é #}
          {% if rate_change is not None %}
            {% if rate_change > 0 %}
              <span style="
                  font-size:11px;
                  padding:2px 8px;
                  border-radius:6px;
                  background:#fef2f2;
                  color:#b91c1c;
                  font-weight:500;
              ">
                ‚ñ≤ +{{ rate_change|floatformat:2 }} –ø.–ø.
              </span>
            {% elif rate_change < 0 %}
              <span style="
                  font-size:11px;
                  padding:2px 8px;
                  border-radius:6px;
                  background:#ecfdf5;
                  color:#166534;
                  font-weight:500;
              ">
                ‚ñº {{ rate_change|floatformat:2 }} –ø.–ø.
              </span>
            {% endif %}
          {% endif %}
        </div>

        <span style="margin-top:4px; font-size:11px; color:#6b7280; max-width:520px;">
          –ó–¥–µ—Å—å —Ö—Ä–∞–Ω—è—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏ –ë–∞–Ω–∫–∞ –†–æ—Å—Å–∏–∏,
          –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –º–æ–¥–µ–ª—è—Ö –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —Å—Ü–µ–Ω–∞—Ä–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ –∏ –æ—Ü–µ–Ω–∫–µ –ø—Ä–æ–µ–∫—Ç–æ–≤.
        </span>
      </div>
    </div>

    {# –°–ü–ï–ô–°–ï–† #}
    <div style="flex:1;"></div>

    {# –ü–†–ê–í–ê–Ø –ö–ê–†–¢–û–ß–ö–ê: –î–ï–ô–°–¢–í–ò–Ø #}
    <div style="
        min-width:230px;
        max-width:260px;
        border-radius:14px;
        background:rgba(248,250,252,0.96);
        box-shadow:0 18px 40px rgba(15,23,42,0.16);
        padding:10px 12px 12px;
        display:flex;
        flex-direction:column;
        gap:8px;
    ">
      <div style="display:flex;justify-content:space-between;align-items:baseline;">
        <span style="
            font-size:11px;
            letter-spacing:0.14em;
            text-transform:uppercase;
            color:#9ca3af;
        ">
          –ù–∞–≤–∏–≥–∞—Ü–∏—è
        </span>
        <span style="font-size:13px;font-weight:600;color:#0f172a;">
          –î–µ–π—Å—Ç–≤–∏—è
        </span>
      </div>

      <div style="display:flex;flex-direction:column;gap:6px;margin-top:2px;">

        <a href="{% url 'admin:macro_keyrate_sync_from_cbr' %}"
           class="button"
           style="
             font-size:13px;
             padding:4px 10px;
             border-radius:6px;
             display:inline-flex;
             align-items:center;
             gap:6px;
             justify-content:flex-start;
           ">
          üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å —Å–∞–π—Ç–∞ –¶–ë –†–§
        </a>

        {% if has_add_permission %}
          <a href="{{ add_url }}"
             class="button"
             style="
               font-size:13px;
               padding:4px 10px;
               border-radius:6px;
               display:inline-flex;
               align-items:center;
               gap:6px;
               justify-content:flex-start;
               background:#e0f2fe;
             ">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ —Å—Ç–∞–≤–∫–µ
          </a>
        {% endif %}
      </div>
    </div>

  </div>

  {# –ö–ê–†–¢–û–ß–ö–ê –° –ì–†–ê–§–ò–ö–û–ú ‚Äî –û–¢–î–ï–õ–¨–ù–ê–Ø –ü–û–õ–û–°–ê –ü–û–î –®–ê–ü–ö–û–ô #}
  <div style="
      margin-top:8px;
      border-radius:14px;
      background:rgba(248,250,252,0.96);
      box-shadow:0 18px 40px rgba(15,23,42,0.10);
      padding:10px 14px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:stretch;
  ">
    <div style="flex:0 0 180px; display:flex; flex-direction:column; gap:4px;">
      <span style="font-size:13px;font-weight:600;color:#0f172a;">
        –î–∏–Ω–∞–º–∏–∫–∞ –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏
      </span>
      <span style="font-size:11px;color:#6b7280;">
        –ò—Å—Ç–æ—Ä–∏—è –ø–æ –¥–∞–Ω–Ω—ã–º –¶–ë –†–§. –ù–∞–≤–µ–¥–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞ —Ç–æ—á–∫–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞–≤–∫—É –Ω–∞ –¥–∞—Ç—É.
      </span>
    </div>

    <div style="
        flex:1 1 260px;
        min-width:240px;
        position:relative;
        border-radius:10px;
        border:1px solid #e5e7eb;
        background:linear-gradient(to bottom,#ffffff,#f9fafb);
        padding:6px 8px;
        overflow:hidden;
    ">
      <svg id="keyrate-chart-main"
           viewBox="0 0 260 80"
           preserveAspectRatio="none"
           style="width:100%;height:80px;display:block;">
      </svg>

      <div id="keyrate-tooltip" class="kr-tooltip">
        <div class="kr-tooltip-rate"></div>
        <div class="kr-tooltip-date"></div>
      </div>
    </div>
  </div>

  {# –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ ‚Äî –•–õ–ï–ë–ù–´–ï –ö–†–û–®–ö–ò + –°–ß–Å–¢–ß–ò–ö #}
  <div style="
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      padding:6px 2px 0;
      border-top:1px solid #e5e7eb;
      color:#6b7280;
      font-size:11px;
  ">
    <nav style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;">
      <a href="{% url 'admin:index' %}"
         style="text-transform:uppercase;letter-spacing:0.08em;text-decoration:none;color:#9ca3af;">
        –ù–ê–ß–ê–õ–û
      </a>
      <span>‚Ä∫</span>
      <span style="text-transform:uppercase;letter-spacing:0.08em;color:#9ca3af;">
        –ú–ê–ö–†–û–ü–û–ö–ê–ó–ê–¢–ï–õ–ò
      </span>
      <span>‚Ä∫</span>
      <span style="text-transform:uppercase;letter-spacing:0.08em;color:#4b5563;font-weight:600;">
        –ö–õ–Æ–ß–ï–í–ê–Ø –°–¢–ê–í–ö–ê
      </span>
    </nav>

    <span style="color:#9ca3af;">
      {{ cl.result_count }} –∑–∞–ø–∏—Å–µ–π
    </span>
  </div>
{% endblock %}

{% block extrahead %}
  {{ block.super }}

  <link rel="stylesheet" href="{% static 'macro/keyrate_admin.css' %}">

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const data = {{ history_json|default:"[]" }};
    if (!data.length) return;

    const svg = document.getElementById('keyrate-chart-main');
    const tooltip = document.getElementById('keyrate-tooltip');
    const width = 260, height = 80;
    const ns = "http://www.w3.org/2000/svg";

    const rates = data.map(p => p.rate);
    const minRate = Math.min(...rates);
    const maxRate = Math.max(...rates);
    const span = maxRate - minRate || 1;

    const x = i => (width - 4) * i / (data.length - 1) + 2;
    const y = v => height - 6 - (v - minRate) / span * (height - 12);

    let pathData = "";
    data.forEach((p, i) => {
      pathData += (i === 0 ? "M" : "L") + x(i) + " " + y(p.rate) + " ";
    });

    // –∑–∞–ª–∏–≤–∫–∞ –ø–æ–¥ –∫—Ä–∏–≤–æ–π
    const areaPath = pathData +
                     "L " + x(data.length - 1) + " " + (height - 2) +
                     " L " + x(0) + " " + (height - 2) + " Z";
    const area = document.createElementNS(ns, "path");
    area.setAttribute("d", areaPath);
    area.setAttribute("fill", "rgba(37,99,235,0.10)");
    svg.appendChild(area);

    // –ª–∏–Ω–∏—è
    const path = document.createElementNS(ns, "path");
    path.setAttribute("d", pathData);
    path.setAttribute("fill", "none");
    path.setAttribute("stroke", "#2563eb");
    path.setAttribute("stroke-width", "2.2");
    path.setAttribute("stroke-linecap", "round");
    path.setAttribute("stroke-linejoin", "round");

    const totalLength = path.getTotalLength();
    path.style.strokeDasharray = totalLength;
    path.style.strokeDashoffset = totalLength;
    path.style.transition = 'stroke-dashoffset 1.3s ease-out';
    requestAnimationFrame(() => {
      path.style.strokeDashoffset = '0';
    });

    svg.appendChild(path);

    // —Ç–æ—á–∫–∏ + tooltip
    data.forEach((p, i) => {
      const cx = x(i);
      const cy = y(p.rate);

      const dot = document.createElementNS(ns, "circle");
      dot.setAttribute("cx", cx);
      dot.setAttribute("cy", cy);

      if (i === data.length - 1) {
        dot.setAttribute("r", 3.4);
        dot.setAttribute("fill", "#2563eb");
        dot.setAttribute("stroke", "#eff6ff");
        dot.setAttribute("stroke-width", "1.2");
      } else {
        dot.setAttribute("r", 2.2);
        dot.setAttribute("fill", "#93c5fd");
      }

      dot.addEventListener('mouseenter', () => {
        if (!tooltip) return;
        const rate = p.rate;
        const isoDate = p.date;
        const rateText = typeof rate === 'number'
          ? rate.toFixed(2) + '%'
          : rate + '%';

        let dateText = '';
        if (isoDate) {
          const parts = isoDate.slice(0,10).split('-'); // [YYYY, MM, DD]
          dateText = parts.reverse().join('.');        // –î–î.–ú–ú.–ì–ì–ì–ì
        }

        tooltip.querySelector('.kr-tooltip-rate').textContent = rateText;
        tooltip.querySelector('.kr-tooltip-date').textContent = dateText;

        const shell = svg.parentElement;
        const relX = (cx / width) * shell.clientWidth;
        const relY = (cy / height) * shell.clientHeight;

        tooltip.style.left = relX + 'px';
        tooltip.style.top  = relY + 'px';
        tooltip.style.opacity = '1';
      });

      dot.addEventListener('mouseleave', () => {
        if (tooltip) tooltip.style.opacity = '0';
      });

      svg.appendChild(dot);
    });

    // tooltip –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–µ
    if (tooltip && data.length) {
      const lastIndex = data.length - 1;
      const last = data[lastIndex];
      const lastX = x(lastIndex);
      const lastY = y(last.rate);

      const shell = svg.parentElement;
      const relX = (lastX / width) * shell.clientWidth;
      const relY = (lastY / height) * shell.clientHeight;

      const rateText = typeof last.rate === 'number'
        ? last.rate.toFixed(2) + '%'
        : last.rate + '%';

      let dateText = '';
      if (last.date) {
        const parts = last.date.slice(0,10).split('-');
        dateText = parts.reverse().join('.');
      }

      tooltip.querySelector('.kr-tooltip-rate').textContent = rateText;
      tooltip.querySelector('.kr-tooltip-date').textContent = dateText;
      tooltip.style.left = relX + 'px';
      tooltip.style.top  = relY + 'px';
      tooltip.style.opacity = '1';
    }
  });
  </script>
{% endblock %}

{% block content %}
  {{ block.super }}
{% endblock %}

