{% load static %}

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>
    –ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞
    {% if current_rate_date %} –Ω–∞ {{ current_rate_date|date:"d.m.Y" }}{% endif %}
    ‚Äî –ø–µ—á–∞—Ç—å
  </title>

  {# –æ—Ç–¥–µ–ª—å–Ω—ã–π CSS –ø–æ–¥ –ø–µ—á–∞—Ç—å –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏ #}
  <link rel="stylesheet" href="{% static 'macro/keyrate_print.css' %}">
  {# –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å Plotly ‚Äî –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å CDN #}
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>

<body>
<div class="page-wrap">

  <div class="card">

    {# —Ç—É–ª–±–∞—Ä #}
    <div class="toolbar">
      <a href="{% url 'admin:macro_keyrate_changelist' %}" class="btn-back">
        ‚Üê –ö —Å–ø–∏—Å–∫—É —Å—Ç–∞–≤–æ–∫
      </a>

      <button class="btn-print" onclick="window.print()">
        <span class="icon">üñ®</span>
        <span>–ü–µ—á–∞—Ç—å</span>
      </button>
    </div>

    {# —à–∞–ø–∫–∞ #}
    <div class="header">
      <div class="title-block">
        <div class="title-label">–ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∞</div>
        <h1>–ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –ë–∞–Ω–∫–∞ –†–æ—Å—Å–∏–∏</h1>

        {% if current_rate and current_rate_date %}
          <div class="subtitle">
            –æ—Ç 
            <strong>{{ current_rate_date|date:"d.m.Y" }}</strong>
            —Å—Ç–∞–≤–∫–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç
            <strong>{{ current_rate }}%</strong>.
          </div>
        {% endif %}
      </div>

      <div class="tag">–ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∞–≤–∫–∏</div>
    </div>

    {# I. –°–≤–æ–¥–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç–∞–≤–∫–µ #}
    <div class="section">
      <div class="section-title">–°–≤–æ–¥–∫–∞</div>
      <div class="section-sub">
        –¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ –ë–∞–Ω–∫–∞ –†–æ—Å—Å–∏–∏ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º.
      </div>

      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è</div>
          <div class="summary-value">
            {% if current_rate_date %}
              {{ current_rate_date|date:"d.m.Y" }}
            {% else %}
              ‚Äî
            {% endif %}
          </div>
        </div>

        <div class="summary-item">
          <div class="summary-label">–ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞</div>
          <div class="summary-value">
            {% if current_rate %}
              {{ current_rate }}%
            {% else %}
              ‚Äî
            {% endif %}
          </div>
        </div>

        <div class="summary-item">
          <div class="summary-label">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ</div>
          <div class="summary-value">
            {% if prev_rate_date and prev_rate %}
              {{ prev_rate_date|date:"d.m.Y" }} ‚Äî {{ prev_rate }}%
            {% else %}
              ‚Äî
            {% endif %}
          </div>

          {% if rate_change is not None %}
            {% if rate_change > 0 %}
              <div class="delta-down">
                ‚ñ≤ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç–∞–≤–∫–µ:
                +{{ rate_change|floatformat:2 }} –ø.–ø.
              </div>
            {% elif rate_change < 0 %}
              <div class="delta-up">
                ‚ñº –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç–∞–≤–∫–µ:
                {{ rate_change|floatformat:2 }} –ø.–ø.
              </div>
            {% else %}
              <div class="delta-flat">
                ‚ñ† –°—Ç–∞–≤–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è.
              </div>
            {% endif %}
          {% endif %}
        </div>

      </div>
    </div>

        {# II. –ö—Ä–∞—Ç–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Ä–µ—à–µ–Ω–∏–π) #}
    <div class="section section-divider">
      <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏</div>
      <div class="section-sub">
        –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è –ë–∞–Ω–∫–∞ –†–æ—Å—Å–∏–∏ –ø–æ –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–µ
        (–ø–æ–¥—Ä–æ–±–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–º. –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏).
      </div>

      <table>
        <thead>
          <tr>
            <th class="col-date">–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è</th>
            <th class="col-sum">–ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞</th>
          </tr>
        </thead>
        <tbody>
          {% if history %}
            {# history —É–∂–µ –Ω–æ–≤—ã–µ ‚Üí —Å—Ç–∞—Ä—ã–µ, –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–µ 5 #}
            {% for item in history|slice:":5" %}
              <tr{% if current_rate_date and item.date == current_rate_date %} class="row-current"{% endif %}>
                <td class="col-date">
                  {{ item.date|date:"d.m.Y" }}
                </td>
                <td class="col-sum">
                  {{ item.rate }}%
                  {% if item.delta is not None %}
                    {% if item.delta > 0 %}
                      <div class="delta-down">
                        ‚ñ≤ +{{ item.delta|floatformat:2 }} –ø.–ø.
                      </div>
                    {% elif item.delta < 0 %}
                      <div class="delta-up">
                        ‚ñº {{ item.delta|floatformat:2 }} –ø.–ø.
                      </div>
                    {% else %}
                      <div class="delta-flat">
                        ‚ñ† –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                      </div>
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr class="empty-row">
              <td colspan="2">
                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

       

      

      {# –î–ª—è –ø–µ—á–∞—Ç–∏ –ª—É—á—à–µ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—â–µ —Ç–∞–∫: #}
      {% if history_json %}
        {% with history=history_json|safe %}
        {% endwith %}
      {% endif %}
    </div>

    {# –£–ø—Ä–æ—Å—Ç–∏–º: —Ç–∞–±–ª–∏—Ü—É —Å–¥–µ–ª–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –≥—Ä–∞—Ñ–∏–∫ ‚Äî —á–µ—Ä–µ–∑ Plotly –Ω–∏–∂–µ #}
    <div class="section section-divider">
      <div class="section-title">–ì—Ä–∞—Ñ–∏–∫ –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏</div>
      <div class="section-sub">
        –î–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏ –ø–æ –¥–∞—Ç–∞–º —Ä–µ—à–µ–Ω–∏–π.
      </div>

      <div id="keyrate-print-chart" class="valuation-kadastr-chart"></div>

      <div class="chart-dual-legend">
        <span class="legend-box legend-box-valuation"></span>
        –ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞, %
        <div class="chart-dual-legend-note">
          –¢–æ—á–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –¥–∞—Ç–∞–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏.
        </div>
      </div>
    </div>


     {# II.a –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è (–≤—Å–µ –∑–∞–ø–∏—Å–∏) #}
    <div class="section section-divider page-break">
      <div class="section-title">
        –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ 1. –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏
      </div>
      <div class="section-sub">
        –í—Å–µ —Ä–µ—à–µ–Ω–∏—è –ë–∞–Ω–∫–∞ –†–æ—Å—Å–∏–∏ –ø–æ –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–µ, –Ω–∞—á–∏–Ω–∞—è —Å –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏
        –≤ –±–∞–∑–µ (—Ç–æ–ª—å–∫–æ –¥–∞—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π).
      </div>

      <table>
        <thead>
          <tr>
            <th class="col-date">–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è</th>
            <th class="col-sum">–ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞</th>
          </tr>
        </thead>
        <tbody>
          {% if history %}
            {% for item in history %}
              <tr{% if current_rate_date and item.date == current_rate_date %} class="row-current"{% endif %}>
                <td class="col-date">
                  {{ item.date|date:"d.m.Y" }}
                </td>
                <td class="col-sum">
                  {{ item.rate }}%
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr class="empty-row">
              <td colspan="2">
                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>


    <div class="footer-note">
      –ü–µ—á–∞—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
      –ü—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –ø–æ –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –∫–∞—Ä—Ç–æ—á–∫–∏.
    </div>

  </div>

</div>

<script>
  // –¥–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑ Django
  const historyData = {{ history_json|default:"[]" }};

  (function () {
    if (!historyData.length || typeof Plotly === 'undefined') return;

    const labels = historyData.map(p => {
      const d = new Date(p.date);
      return d.toLocaleDateString('ru-RU');
    });
    const rates  = historyData.map(p => p.rate);

    const trace = {
      x: labels,
      y: rates,
      type: "scatter",
      mode: "lines+markers",
      line: { shape: "hv", width: 3, color: "#2563eb" },  // –ø–æ—á—Ç–∏ "—Å—Ç—É–ø–µ–Ω—å–∫–∞"
      marker: { size: 8, color: "#bfdbfe", line: { width: 2, color: "#2563eb" } },
      name: "–ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞"
    };

    const layout = {
      margin: { l: 50, r: 20, t: 10, b: 60 },
      yaxis: {
        title: "–°—Ç–∞–≤–∫–∞, %",
        rangemode: "tozero"
      },
      xaxis: {
        tickangle: -45
      },
      showlegend: false
    };

    const config = {
      displayModeBar: false,
      responsive: true
    };

    Plotly.newPlot("keyrate-print-chart", [trace], layout, config);
  })();
</script>

</body>
</html>
