{# templates/admin/macro/currencyrate/print.html #}
{% load static %}

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>
    –ö—É—Ä—Å {{ currency }} –∫ {{ base_currency }}
    {% if current_date %} –Ω–∞ {{ current_date|date:"d.m.Y" }}{% endif %}
    ‚Äî –ø–µ—á–∞—Ç—å
  </title>

  {# –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ CSS, —á—Ç–æ –∏ —É –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏ #}
  <link rel="stylesheet" href="{% static 'macro/keyrate_print.css' %}">
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>

<body>
<div class="page-wrap">

  <div class="card">

    {# —Ç—É–ª–±–∞—Ä #}
    <div class="toolbar">
      <a href="{% url 'admin:macro_currencyrate_changelist' %}" class="btn-back">
        ‚Üê –ö —Å–ø–∏—Å–∫—É –∫—É—Ä—Å–æ–≤
      </a>

      <button class="btn-print" onclick="window.print()">
        <span class="icon">üñ®</span>
        <span>–ü–µ—á–∞—Ç—å</span>
      </button>
    </div>

    {# —à–∞–ø–∫–∞ #}
    <div class="header">
      <div class="title-block">
        <div class="title-label">–ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∞</div>
        <h1>–ö—É—Ä—Å {{ currency_with_flag }} –∫ {{ base_currency }}</h1>
   

        {% if current_rate and current_date %}
          <div class="subtitle">
            –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞
            <strong>{{ current_date|date:"d.m.Y" }}</strong>
            –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫—É—Ä—Å —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç
            <strong>{{ current_rate }} {{ base_currency }}</strong>
            –∑–∞ 1 {{ currency }}.
          </div>
        {% endif %}
      </div>

      <div class="tag">–ö–∞—Ä—Ç–æ—á–∫–∞ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç—ã</div>
    </div>

    {# I. –°–≤–æ–¥–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫—É—Ä—Å—É #}
    <div class="section">
      <div class="section-title">–°–≤–æ–¥–∫–∞</div>
      <div class="section-sub">
        –¢–µ–∫—É—â–∏–π –∫—É—Ä—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∞–ª—é—Ç—ã –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º.
      </div>

      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">–í–∞–ª—é—Ç–∞</div>
          <div class="summary-value">
            {{ currency }} / {{ base_currency }}
          </div>
        </div>

        <div class="summary-item">
          <div class="summary-label">–î–∞—Ç–∞ –∫—É—Ä—Å–∞</div>
          <div class="summary-value">
            {% if current_date %}
              {{ current_date|date:"d.m.Y" }}
            {% else %}
              ‚Äî
            {% endif %}
          </div>
        </div>

        <div class="summary-item">
          <div class="summary-label">–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å</div>
          <div class="summary-value">
            {% if current_rate %}
              {{ current_rate }} {{ base_currency }}
            {% else %}
              ‚Äî
            {% endif %}
          </div>
        </div>

        <div class="summary-item">
          <div class="summary-label">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</div>
          <div class="summary-value">
            {% if prev_date and prev_rate %}
              {{ prev_date|date:"d.m.Y" }} ‚Äî {{ prev_rate }} {{ base_currency }}
            {% else %}
              ‚Äî
            {% endif %}
          </div>

          {% if rate_change is not None %}
            {% if rate_change > 0 %}
              <div class="delta-down">
                ‚ñ≤ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∑–Ω–∞—á–µ–Ω–∏—é:
                +{{ rate_change|floatformat:4 }}
              </div>
            {% elif rate_change < 0 %}
              <div class="delta-up">
                ‚ñº –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∑–Ω–∞—á–µ–Ω–∏—é:
                {{ rate_change|floatformat:4 }}
              </div>
            {% else %}
              <div class="delta-flat">
                ‚ñ† –ö—É—Ä—Å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –¥–∞—Ç—ã.
              </div>
            {% endif %}
          {% endif %}
        </div>

 
    </div>

    {# II. –ö—Ä–∞—Ç–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏) #}
    <div class="section section-divider">
      <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è –∫—É—Ä—Å–∞</div>
      <div class="section-sub">
        –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫—É—Ä—Å–∞ {{ currency }} –∫ {{ base_currency }}.
      </div>

      <table>
        <thead>
          <tr>
            <th class="col-date">–î–∞—Ç–∞</th>
            <th class="col-sum">–ö—É—Ä—Å</th>
          </tr>
        </thead>
        <tbody>
          {% if history %}
            {% for item in history %}
              <tr{% if current_date and item.date == current_date %} class="row-current"{% endif %}>
                <td class="col-date">
                  {{ item.date|date:"d.m.Y" }}
                </td>
                <td class="col-sum">
                  {{ item.rate }} {{ base_currency }}
                  {% if item.delta is not None %}
                    {% if item.delta > 0 %}
                      <div class="delta-down">
                        ‚ñ≤ +{{ item.delta|floatformat:4 }}
                      </div>
                    {% elif item.delta < 0 %}
                      <div class="delta-up">
                        ‚ñº {{ item.delta|floatformat:4 }}
                      </div>
                    {% else %}
                      <div class="delta-flat">
                        ‚ñ† –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                      </div>
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr class="empty-row">
              <td colspan="2">
                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –∫—É—Ä—Å–∞ —ç—Ç–æ–π –≤–∞–ª—é—Ç—ã.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {# III. –ì—Ä–∞—Ñ–∏–∫ –∫—É—Ä—Å–∞ #}
    <div class="section section-divider">
      <div class="section-title">–ì—Ä–∞—Ñ–∏–∫ –∫—É—Ä—Å–∞</div>
      <div class="section-sub">
        –î–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫—É—Ä—Å–∞ {{ currency }} –∫ {{ base_currency }} –ø–æ –¥–∞—Ç–∞–º.
      </div>

      <div id="currency-print-chart" class="valuation-kadastr-chart"></div>

      <div class="chart-dual-legend">
        <span class="legend-box legend-box-valuation"></span>
        –ö—É—Ä—Å {{ currency }} / {{ base_currency }}
        <div class="chart-dual-legend-note">
          –¢–æ—á–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –¥–∞—Ç–∞–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.
        </div>
      </div>
    </div>

    <div class="footer-note">
      –ü–µ—á–∞—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
      –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫—É—Ä—Å–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –∫–∞—Ä—Ç–æ—á–∫–∏.
    </div>

  </div>

</div>

<script>
  const historyData = {{ history_json|default:"[]" }};

  (function () {
    if (!historyData.length || typeof Plotly === 'undefined') return;

    const labels = historyData.map(p => {
      const d = new Date(p.date);
      return d.toLocaleDateString('ru-RU');
    });
    const rates  = historyData.map(p => p.rate);

    // –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω –æ—Å–∏ Y
    let minRate = Math.min.apply(null, rates);
    let maxRate = Math.max.apply(null, rates);

    if (minRate === maxRate) {
      minRate = minRate - 0.1;
      maxRate = maxRate + 0.1;
    } else {
      const padding = (maxRate - minRate) * 0.3;
      minRate = minRate - padding;
      maxRate = maxRate + padding;
    }

    const trace = {
      x: labels,
      y: rates,
      type: "scatter",
      mode: "lines+markers",
      line: { shape: "linear", width: 2, color: "#2563eb" },
      marker: { size: 6, color: "#bfdbfe", line: { width: 1, color: "#2563eb" } },
      name: "–ö—É—Ä—Å"
    };

    const layout = {
      margin: { l: 50, r: 20, t: 10, b: 60 },
      yaxis: {
        title: "–ö—É—Ä—Å",
        range: [minRate, maxRate]
      },
      xaxis: {
        tickangle: -45
      },
      showlegend: false
    };

    const config = {
      displayModeBar: false,
      responsive: true
    };

    Plotly.newPlot("currency-print-chart", [trace], layout, config);
  })();
</script>

</body>
</html>

