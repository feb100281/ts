{# templates/admin/properties/print/_group_card.html #}

<div class="card group-card">

  {# --- –¢—É–ª–±–∞—Ä --- #}
  <div class="toolbar">
    <a href="{% url 'admin:properties_properygroup_changelist' %}" class="btn-back">
      ‚Üê –ö —Å–ø–∏—Å–∫—É –≥—Ä—É–ø–ø
    </a>

    <button class="btn-print" onclick="window.print()">
      <span class="icon">üñ®</span>
      <span>–ü–µ—á–∞—Ç—å</span>
    </button>
  </div>

  {# --- –®–∞–ø–∫–∞ –≥—Ä—É–ø–ø—ã --- #}
  <div class="header">
    <div class="title-block">
      <div class="title-label">–ì–†–£–ü–ü–ê –û–ë–™–ï–ö–¢–û–í –ù–ï–î–í–ò–ñ–ò–ú–û–°–¢–ò</div>

      <h1>
        {% if group.logo %}
          <span style="
              font-family:'NotoManu';
              font-size:36px;
              margin-right:10px;
              line-height:1;
              vertical-align:middle;">
            {{ group.logo }}
          </span>
        {% endif %}
        {{ group.name }}
      </h1>

      <div class="subtitle">
        {% if stats.obj_count %}
          –û–±—ä–µ–∫—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ: {{ stats.obj_count }}
        {% endif %}
      </div>

      <div class="subtitle subtitle-date">
        –û—Ç—á—ë—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω: {{ report_date|date:"d.m.Y" }}
      </div>
    </div>

    <div class="tag">
      –ö–ê–†–¢–û–ß–ö–ê –ì–†–£–ü–ü–´
    </div>
  </div>

  {# I. –°–≤–æ–¥–∫–∞ –ø–æ –≥—Ä—É–ø–ø–µ #}
  <section class="section">
    <h2 class="section-title">I. –°–≤–æ–¥–∫–∞ –ø–æ –≥—Ä—É–ø–ø–µ</h2>

    <div class="summary-grid">

      <div class="summary-item">
        <div class="summary-label">–û–±—ä–µ–∫—Ç–æ–≤</div>
        <div class="summary-value">{{ stats.obj_count|default:"‚Äî" }}</div>
      </div>

      <div class="summary-item">
        <div class="summary-label">–°—É–º–º–∞—Ä–Ω–∞—è –ø–ª–æ—â–∞–¥—å</div>
        <div class="summary-value">
          {{ stats_fmt.total_area_str }}{% if stats_fmt.total_area_str != "‚Äî" %} –º¬≤{% endif %}
        </div>
      </div>

      <div class="summary-item">
        <div class="summary-label">–†—ã–Ω–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å, –≤—Å–µ–≥–æ</div>
        <div class="summary-value">
          {{ stats_fmt.total_valuation_str }}
        </div>
      </div>

      <div class="summary-item">
        <div class="summary-label">–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ 1 –º¬≤</div>
        <div class="summary-value">
          {{ stats_fmt.avg_per_sqm_str }}
        </div>
      </div>

    </div>
  </section>

  {# II. –û–±—ä–µ–∫—Ç—ã –≤ –≥—Ä—É–ø–ø–µ #}
  <section class="section">
    <h2 class="section-title">II. –û–±—ä–µ–∫—Ç—ã –≤ –≥—Ä—É–ø–ø–µ</h2>

    {% if property_rows %}
      <table class="print-table">
        <thead>
          <tr>
            <th>–û–±—ä–µ–∫—Ç</th>
            <th class="text-right">–ü–ª–æ—â–∞–¥—å, –º¬≤</th>
            <th class="text-right">–†—ã–Ω–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
            <th class="text-right">–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
            <th class="text-right">–†—ã–Ω./–∫–∞–¥.</th>
          </tr>
        </thead>

        <tbody>
        {% for row in property_rows %}
          {% with prop=row.property %}
          <tr>

            <td>
              <div class="prop-name">
                {{ prop.name }}
              </div>

              {% if prop.kadastr_number %}
                <div class="prop-kadastr">
                  –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π ‚Ññ {{ prop.kadastr_number }}
                </div>
              {% endif %}

              {% if prop.address %}
                <div class="prop-address">
                  {{ prop.address }}
                </div>
              {% endif %}
            </td>

            <td class="text-right">
              {{ row.area_str }}
            </td>

            <td class="text-right">
              {{ row.amount_str }}
            </td>

            <td class="text-right">
              {{ row.kadastr_amount_str }}
            </td>

            <td class="text-right">
              {{ row.mv_to_kv_ratio_str }}
            </td>

          </tr>
          {% endwith %}
        {% endfor %}
        </tbody>
      </table>

    {% else %}
      <p>–í –≥—Ä—É–ø–ø–µ –Ω–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤.</p>
    {% endif %}
  </section>

  {# III. –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –†–° / –ö–° –ø–æ –¥–∞—Ç–∞–º –æ—Ü–µ–Ω–æ–∫ #}
  {% include "admin/properties/print/_valuation_vs_kadastr_plotly.html" %}

    {# IV. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä—ã–Ω–æ—á–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º (Waterfall) #}
  {% include "admin/properties/print/_group_waterfall_plotly.html" %}

  {# V. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –†–° / –ö–° –ø–æ –æ–±—ä–µ–∫—Ç–∞–º #}
  {% include "admin/properties/print/_group_mvkv_distribution_plotly.html" %}

  {# VI. –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏) #}
  {% if individual_charts %}
    <section class="section">
      <h2 class="section-title">V. –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</h2>
      <ol class="appendix-toc">
        {% for chart in individual_charts %}
          <li>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ {{ forloop.counter }} ‚Äî {{ chart.property.name }}</li>
        {% endfor %}
      </ol>
    </section>
  {% endif %}

  <div class="footer-note">
    –ü–µ—á–∞—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
    –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞ –≥—Ä—É–ø–ø—ã –∏–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –æ–±—ä–µ–∫—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –æ—Ç—á—ë—Ç–∞.
  </div>

</div>  {# –∫–æ–Ω–µ—Ü .card.group-card #}

{# VII. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º #}
{% if individual_charts %}

  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  {% for chart in individual_charts %}
    {% if chart.data %}
      <div class="page-break"></div>

      <div class="block block-chart">

        <h3 class="block-title">
          –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ {{ forloop.counter }} ‚Äî {{ chart.property.name }}<br>
          <span class="block-subtitle">
            –ì—Ä—É–ø–ø–∞: {{ group.name }}
          </span>
        </h3>

        <div id="{{ chart.chart_id }}" class="valuation-kadastr-chart"></div>

        <div class="chart-dual-legend">
          <div>
            <span class="legend-box legend-box-valuation"></span>
            –†—ã–Ω–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (–†–°)
          </div>
          <div>
            <span class="legend-box legend-box-kadastr"></span>
            –ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (–ö–°)
          </div>
          <div class="chart-dual-legend-note">
            –õ–∏–Ω–∏—è —Å ¬´√ó¬ª –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –†–° / –ö–° (–≤—Ç–æ—Ä–∞—è —à–∫–∞–ª–∞).
          </div>
        </div>

      </div>

      <script>
      (function() {
        const data = {{ chart.data|safe }};
        if (!data) return;

        const chartId = "{{ chart.chart_id }}";
        const el = document.getElementById(chartId);
        if (!el) return;

        const labels    = data.labels || [];
        const valuation = data.valuation || [];
        const kadastr   = data.kadastr || [];
        const ratio     = data.ratio || [];

        const valuationM = valuation.map(v => v ? v/1e6 : 0);
        const kadastrM   = kadastr.map(v => v ? v/1e6 : 0);

        function fm(v) {
          return (v || 0).toLocaleString("ru-RU", {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1
          });
        }

        const traceVal = {
          x: labels,
          y: valuationM,
          type: "bar",
          name: "–†–°",
          marker: { color: "#3b82f6" },
          yaxis: "y1",
          text: valuationM.map(fm),
          textposition: "inside",
          textfont: { size: 9, color: "#fff" },
        };

        const traceKad = {
          x: labels,
          y: kadastrM,
          type: "bar",
          name: "–ö–°",
          marker: { color: "#9ca3af" },
          yaxis: "y1",
          text: kadastrM.map(fm),
          textposition: "inside",
          textfont: { size: 9, color: "#111" },
        };

        const traceRatio = {
          x: labels,
          y: ratio,
          type: "scatter",
          mode: "lines+markers+text",
          name: "–†–° / –ö–°",
          yaxis: "y2",
          line: { shape: "spline", color: "#16a34a" },
          marker: { size: 6, color: "#16a34a" },
          text: ratio.map(r => r ? r.toFixed(2) + "√ó" : ""),
          textposition: "top center",
          textfont: { size: 9 },
          cliponaxis: false,
        };

        const layout = {
          barmode: "group",
          margin: { l: 70, r: 70, t: 10, b: 70 },
          legend: { orientation: "h", y: -0.3 },
          yaxis: { title: "–°—Ç–æ–∏–º–æ—Å—Ç—å, –º–ª–Ω ‚ÇΩ", tickformat: ",.1f", rangemode: "tozero" },
          yaxis2: { title: "–†–° / –ö–°, √ó", overlaying: "y", side: "right", rangemode: "tozero" },
          xaxis: { tickangle: -45 },
        };

        const config = {
          displayModeBar: false,
          responsive: true,
        };

        Plotly.newPlot(el, [traceVal, traceKad, traceRatio], layout, config);
      })();
      </script>

    {% endif %}
  {% endfor %}
{% endif %}
