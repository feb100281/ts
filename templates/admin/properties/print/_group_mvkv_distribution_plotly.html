{# templates/admin/properties/print/_group_mvkv_distribution_plotly.html #}

{% if mvkv_distribution_plot_data %}
<section class="section">
  <h2 class="section-title">IV. Распределение соотношения РС / КС по объектам</h2>
  <div id="{{ mvkv_distribution_chart_id }}" class="valuation-kadastr-chart"></div>
  <div class="chart-dual-legend-note">
    Столбцы показывают, сколько объектов попадает в каждый диапазон РС / КС.
  </div>
</section>

<script>
(function() {
  const data = {{ mvkv_distribution_plot_data|safe }};
  if (!data) return;

  const labels = data.labels || [];
  const counts = data.counts || [];

  const trace = {
    x: labels,
    y: counts,
    type: "bar",
    text: counts.map(c => c ? c.toString() : ""),
    textposition: "outside",
    textfont: { size: 10 },
  };

  const maxY = counts.length ? Math.max.apply(null, counts) : 0;

  const layout = {
    margin: { l: 70, r: 30, t: 40, b: 60 },
    yaxis: {
      title: "Количество объектов",
      rangemode: "tozero",
      range: maxY ? [0, maxY * 1.3] : undefined,
      dtick: 1,
    },
    xaxis: {
      tickangle: -15,
    },
    showlegend: false,
  };

  const config = {
    displayModeBar: false,
    responsive: true,
  };

  const el = document.getElementById("{{ mvkv_distribution_chart_id }}");
  if (!el) return;
  Plotly.newPlot(el, [trace], layout, config);
})();
</script>
{% endif %}
