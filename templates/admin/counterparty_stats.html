{% load static %}
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Аналитика по контрагентам</title>
  <style>
    :root {
      --bg:#f5f5f5;
      --card:#ffffff;
      --border:#e2e8f0;
      --accent:#111827;
      --muted:#6b7280;
      --accent-main:#2563eb;
      --accent-soft:#eff4ff;
    }

    * { box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin:0;
      padding:24px 16px;
      background:var(--bg);
      display:flex;
      justify-content:center;
      color:var(--accent);
    }

    .page-wrap {
      width:100%;
      max-width:1200px;
    }

    /* HEADER */

    .header {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:16px;
    }

    .title-block { flex:1 1 auto; }

    .title-label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
      margin-bottom:4px;
    }

    h1 {
      margin:0;
      font-size:20px;
      font-weight:600;
      color:var(--accent);
    }

    .subtitle {
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      max-width:520px;
    }

    .btn-back {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:6px;
      border:1px solid #cbd5e1;
      background:#ffffff;
      color:#111827;
      cursor:pointer;
      font-size:13px;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn-back:hover { background:#e5e7eb; }

    /* SUMMARY CARDS */

    .cards-row {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:12px;
      margin-bottom:16px;
    }

    a.card-link {
      text-decoration:none;
      color:inherit;
    }

    .card {
      background:var(--card);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px 9px;
      transition:box-shadow .15s ease, transform .15s ease, border-color .15s ease;
    }

    a.card-link:hover .card {
      box-shadow:0 8px 18px rgba(15,23,42,.08);
      transform:translateY(-1px);
      border-color:#cbd5e1;
    }

    .card-header-row {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:4px;
    }

    .card-label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }

    .card-badge {
      font-size:10px;
      padding:2px 6px;
      border-radius:6px;
      border:1px solid var(--border);
      color:var(--muted);
      background:#f9fafb;
    }

    .card-value {
      font-size:20px;
      font-weight:600;
      color:var(--accent);
      margin-top:2px;
    }

    .card-hint {
      margin-top:2px;
      font-size:11px;
      color:var(--muted);
    }

    .card-value.risk-high { color:#b91c1c; }
    .card-value.risk-mid  { color:#f97316; }
    .card-value.risk-low  { color:#16a34a; }

    .card-value.fns-ok   { color:#16a34a; }
    .card-value.fns-warn { color:#f97316; }
    .card-value.fns-bad  { color:#b91c1c; }

    /* LAYOUT BELOW */

    .grid-two {
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:12px;
      margin-top:8px;
    }

    @media (max-width: 900px) {
      body { padding:16px 8px; }
      .grid-two { grid-template-columns:1fr; }
    }

    .section-title {
      font-size:13px;
      font-weight:600;
      color:var(--accent);
      margin:0 0 4px;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .section-sub {
      font-size:11px;
      color:var(--muted);
      margin:0 0 8px;
    }

    .section-title a.section-title-link {
      font-size:11px;
      font-weight:400;
      color:var(--accent-main);
      text-decoration:none;
    }
    .section-title a.section-title-link:hover {
      text-decoration:underline;
    }

    /* TABLES */

    table {
      border-collapse:collapse;
      width:100%;
      border-radius:8px;
      overflow:hidden;
      font-size:12px;
      background:#ffffff;
      border:1px solid var(--border);
    }

    thead th {
      background:#f9fafb;
      border-bottom:1px solid var(--border);
      padding:6px 8px;
      text-align:left;
      font-size:11px;
      font-weight:600;
      color:#4b5563;
    }

    tbody td {
      border-bottom:1px solid var(--border);
      padding:6px 8px;
      vertical-align:top;
    }

    tbody tr:last-child td { border-bottom:none; }

    tbody tr:hover td { background:#f9fafb; }

    .cell-name {
      font-weight:500;
      color:var(--accent);
    }

    .cell-muted { color:var(--muted); }

    .cell-link {
      color:var(--accent-main);
      text-decoration:none;
    }
    .cell-link:hover {
      text-decoration:underline;
    }

    /* mini charts in tables */

    .metric-bar {
      position:relative;
      height:18px;
      border-radius:6px;
      background:var(--accent-soft);
      overflow:hidden;
      display:flex;
      align-items:center;
      padding:0 6px;
      font-size:11px;
      white-space:nowrap;
    }

    .metric-bar-fill {
      position:absolute;
      inset:0;
      right:auto;
      background:linear-gradient(90deg,#bfdbfe,#60a5fa);
      opacity:0.9;
    }

    .metric-bar-label {
      position:relative;
      z-index:1;
    }

  </style>
</head>
<body>
<div class="page-wrap">

  <div class="header">
    <div class="title-block">
      <div class="title-label">Аналитика</div>
      <h1>Контрагенты</h1>
      <div class="subtitle">
        Сводная информация по базе контрагентов: риск-профиль, актуальность данных ФНС,
        структура по группам, регионам, ОПФ и видам деятельности (ОКВЭД).
      </div>
    </div>
    <div>
      {% if request.GET.src == "change" and request.GET.pk %}
        <a href="{% url 'admin:counterparties_counterparty_change' request.GET.pk %}"
           class="btn-back">
          ← Назад к контрагенту
        </a>
      {% else %}
        <a href="{% url 'admin:counterparties_counterparty_changelist' %}"
           class="btn-back">
          ← К списку контрагентов
        </a>
      {% endif %}
    </div>
  </div>

  <!-- Карточки: общий объём и риски -->
  <div class="cards-row">

    <a href="{% url 'admin:counterparties_counterparty_changelist' %}"
       class="card-link">
      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Всего контрагентов</div>
          <span class="card-badge">Справочник</span>
        </div>
        <div class="card-value">{{ total }}</div>
        <div class="card-hint">Общее количество записей в базе.</div>
      </div>
    </a>

    <a href="{% url 'admin:counterparties_counterparty_changelist' %}?risk_level=high"
       class="card-link">
      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Высокий риск</div>
          <span class="card-badge">Критичный</span>
        </div>
        <div class="card-value risk-high">{{ high_risk }}</div>
        <div class="card-hint">Санкции и прочие критичные факторы.</div>
      </div>
    </a>

    <a href="{% url 'admin:counterparties_counterparty_changelist' %}?risk_level=mid"
       class="card-link">
      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Средний риск</div>
          <span class="card-badge">Внимание</span>
        </div>
        <div class="card-value risk-mid">{{ mid_risk }}</div>
        <div class="card-hint">Массовые директора, спорные схемы и др.</div>
      </div>
    </a>

    <a href="{% url 'admin:counterparties_counterparty_changelist' %}?risk_level=low"
       class="card-link">
      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Низкий риск</div>
          <span class="card-badge">Рабочий пул</span>
        </div>
        <div class="card-value risk-low">{{ low_risk }}</div>
        <div class="card-hint">Без значимых риск-факторов по тек. данным.</div>
      </div>
    </a>

  </div>

  <!-- Карточки по ФНС -->
  <div class="cards-row">

    <a href="{% url 'admin:counterparties_counterparty_changelist' %}?checko_status=never"
       class="card-link">
      <div class="card">
        <div class="card-header-row">
          <div class="card-label">ФНС: нет отметки</div>
          <span class="card-badge">Приоритет обновления</span>
        </div>
        <div class="card-value fns-bad">{{ fns_never }}</div>
        <div class="card-hint">Карточки без даты обновления из ФНС.</div>
      </div>
    </a>

    <a href="{% url 'admin:counterparties_counterparty_changelist' %}?checko_status=recent"
       class="card-link">
      <div class="card">
        <div class="card-header-row">
          <div class="card-label">ФНС: ≤ 90 дней</div>
          <span class="card-badge">Актуально</span>
        </div>
        <div class="card-value fns-ok">{{ fns_recent }}</div>
        <div class="card-hint">Данные считаются актуальными.</div>
      </div>
    </a>

    <a href="{% url 'admin:counterparties_counterparty_changelist' %}?checko_status=mid"
       class="card-link">
      <div class="card">
        <div class="card-header-row">
          <div class="card-label">ФНС: 3–12 месяцев</div>
          <span class="card-badge">Желательно обновить</span>
        </div>
        <div class="card-value fns-warn">{{ fns_mid }}</div>
        <div class="card-hint">Рекомендуется проверка.</div>
      </div>
    </a>

    <a href="{% url 'admin:counterparties_counterparty_changelist' %}?checko_status=old"
       class="card-link">
      <div class="card">
        <div class="card-header-row">
          <div class="card-label">ФНС: &gt; 1 года</div>
          <span class="card-badge">Просрочено</span>
        </div>
        <div class="card-value fns-bad">{{ fns_old }}</div>
        <div class="card-hint">Кандидаты на первоочередное обновление.</div>
      </div>
    </a>

  </div>

  <!-- Таблицы: группы и регионы -->
  <div class="grid-two">

    <div>
      <p class="section-title">
        Распределение по группам контрагентов
        <a class="section-title-link"
           href="{% url 'admin:counterparties_counterparty_changelist' %}?ordering=gr__name">
          Открыть в списке
        </a>
      </p>
      <p class="section-sub">Сводка по полю «Группа контрагентов».</p>
      <table class="table-metric">
        <thead>
          <tr>
            <th>Группа</th>
            <th>Контрагентов</th>
          </tr>
        </thead>
        <tbody>
          {% for row in by_group %}
            <tr>
              <td class="cell-name">
                {% if row.gr__name %}
                  <a href="{% url 'admin:counterparties_counterparty_changelist' %}?gr__id__exact={{ row.gr__id }}"
                     class="cell-link">
                    {{ row.gr__name }}
                  </a>
                {% else %}
                  <span class="cell-muted">Без группы</span>
                {% endif %}
              </td>
              <td class="cell-count" data-value="{{ row.cnt }}">{{ row.cnt }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="2" class="cell-muted" style="text-align:center;">
                Нет данных по группам
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div>
      <p class="section-title">
        Топ регионов
        <a class="section-title-link"
           href="{% url 'admin:counterparties_counterparty_changelist' %}?ordering=region">
          Открыть в списке
        </a>
      </p>
      <p class="section-sub">Первые 10 регионов по количеству контрагентов.</p>
      <table class="table-metric">
        <thead>
          <tr>
            <th>Регион</th>
            <th>Контрагентов</th>
          </tr>
        </thead>
        <tbody>
          {% for row in by_region %}
            <tr>
              <td>
                {% if row.region %}
                  <a href="{% url 'admin:counterparties_counterparty_changelist' %}?region={{ row.region|urlencode }}"
                     class="cell-link">
                    {{ row.region }}
                  </a>
                {% else %}
                  <span class="cell-muted">Не указан</span>
                {% endif %}
              </td>
              <td class="cell-count" data-value="{{ row.cnt }}">{{ row.cnt }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="2" class="cell-muted" style="text-align:center;">
                Нет данных по регионам
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  <!-- Таблицы: ОПФ и ОКВЭД -->
  <div class="grid-two" style="margin-top:16px;">

    <div>
      <p class="section-title">
        Распределение по ОПФ
          <a class="section-title-link"
            href="{% url 'admin:counterparties_counterparty_changelist' %}">
            Открыть в списке
          </a>
      </p>
      <p class="section-sub">
        Определено по полю «Полн. Наименование».
      </p>
      <table class="table-metric">
        <thead>
          <tr>
            <th>Организационно-правовая форма</th>
            <th>Контрагентов</th>
          </tr>
        </thead>
                <tbody>
          {% for row in by_opf %}
            <tr>
              <td class="cell-name">
                <a href="{% url 'admin:counterparties_counterparty_changelist' %}?okopf_code={{ row.opf_key|urlencode }}"
                   class="cell-link">
                  {{ row.okopf_name|default:row.okopf_name_display }}
                </a>
              </td>
              <td class="cell-count" data-value="{{ row.cnt }}">{{ row.cnt }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="2" class="cell-muted" style="text-align:center;">
                Нет данных по ОПФ
              </td>
            </tr>
          {% endfor %}

          {# Отдельная строка: контрагенты без ОПФ #}
          {% if opf_missing_cnt %}
            <tr>
              <td class="cell-name">
                <a href="{% url 'admin:counterparties_counterparty_changelist' %}?okopf_code=_none"
                   class="cell-link cell-muted">
                  Организационно-правовая форма не указана
                </a>
              </td>
              <td class="cell-count" data-value="{{ opf_missing_cnt }}">{{ opf_missing_cnt }}</td>
            </tr>
          {% endif %}
        </tbody>

      </table>


      </table>
    </div>

    <div>
      <p class="section-title">
        Топ ОКВЭД
        <a class="section-title-link"
           href="{% url 'admin:counterparties_counterparty_changelist' %}?ordering=okved_code">
          Открыть в списке
        </a>
      </p>
      <p class="section-sub">
        Наиболее часто встречающиеся виды деятельности (по основному ОКВЭД).
      </p>
      <table class="table-metric">
        <thead>
          <tr>
            <th>Код</th>
            <th>Наименование</th>
            <th>Контрагентов</th>
          </tr>
        </thead>
        <tbody>
         {% for row in by_okved %}
              <tr>
                <td class="cell-name">
                  <a href="{% url 'admin:counterparties_counterparty_changelist' %}?okved_code={{ row.okved_code|urlencode }}"
                    class="cell-link">
                    {{ row.okved_code }}
                  </a>
                </td>
                <td class="cell-muted">
                  {{ row.okved_name }}
                </td>
                <td class="cell-count" data-value="{{ row.cnt }}">{{ row.cnt }}</td>
              </tr>
          {% empty %}
              <tr>
                <td colspan="3" class="cell-muted" style="text-align:center;">
                  Нет данных по ОКВЭД
                </td>
              </tr>
          {% endfor %}

        </tbody>
      </table>
    </div>

  </div>

</div>

<script>
  // мини-барчарты по количеству контрагентов
  (function () {
    document.querySelectorAll('table.table-metric').forEach(function (table) {
      var cells = Array.from(table.querySelectorAll('td.cell-count'));
      if (!cells.length) return;

      var max = Math.max.apply(null, cells.map(function (c) {
        return parseFloat(c.dataset.value || '0') || 0;
      }));

      cells.forEach(function (cell) {
        var val = parseFloat(cell.dataset.value || '0') || 0;
        var pct = max ? (val / max) * 100 : 0;
        var label = cell.textContent.trim();

        cell.innerHTML =
          '<div class="metric-bar">' +
            '<div class="metric-bar-fill" style="width:' + pct.toFixed(0) + '%"></div>' +
            '<span class="metric-bar-label">' + label + '</span>' +
          '</div>';
      });
    });
  })();
</script>

</body>
</html>


