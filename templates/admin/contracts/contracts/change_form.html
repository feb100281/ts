{% extends "admin/change_form.html" %}
{% load static %}
{% load admin_urls %}

{% block breadcrumbs %}{% endblock %}
{% block object-tools %}{% endblock %}

{% block content_title %}
  {% url opts|admin_urlname:'changelist' as changelist_url %}
  {% url opts|admin_urlname:'add' as add_url %}

  {# –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å #}
  <div class="contracts-topbar">
    <div class="contracts-topbar__left">
      <div class="contracts-icon">üìÑ</div>
      <div class="contracts-topbar__titles">
        <div class="contracts-kicker">–î–æ–≥–æ–≤–æ—Ä</div>

        <div class="contracts-title">
          {% if add %}–ù–æ–≤—ã–π –¥–æ–≥–æ–≤–æ—Ä{% else %}{{ original }}{% endif %}
        </div>

        {# –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç —Å–≤–µ—Ä—Ö—É (–∏ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏, –∏ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è JS-–æ–º) #}
        <div class="contracts-counterparty" id="cpTitle">
          {% if not add and original.cp %}
            {{ original.cp }}
          {% else %}
            ‚Äî
          {% endif %}
        </div>

        <div class="contracts-meta">
          <span class="chip chip-blue">{% if add %}–°–æ–∑–¥–∞–Ω–∏–µ{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% endif %}</span>
          {% if not add and original.pk %}
            <span class="chip chip-gray">ID: {{ original.pk }}</span>
          {% endif %}
          {% if not add and original.date %}
            <span class="chip chip-cyan">–î–∞—Ç–∞: {{ original.date }}</span>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="contracts-topbar__right">
      <a class="link-btn" href="{{ changelist_url }}">‚Üê –ö —Ä–µ–µ—Å—Ç—Ä—É</a>

      {% if has_add_permission %}
        <a class="primary-btn" href="{{ add_url }}">‚ûï –ù–æ–≤—ã–π</a>
      {% endif %}

      {% if not add and original.pk %}
        {% if original.pid_id %}
          <a class="pill-btn" href="../{{ original.pid_id }}/change/">‚Üë –†–æ–¥–∏—Ç–µ–ª—å</a>
        {% endif %}
        <a class="pill-btn" href="{{ changelist_url }}?pid__id__exact={{ original.pk }}">–î–æ–ø–Ω–∏–∫–∏</a>
        <a class="pill-btn" href="#contract-files">–§–∞–π–ª—ã</a>
      {% endif %}
    </div>
  </div>

  {# –ù–∏–∂–Ω—è—è –º–∏–Ω–∏-–Ω–∞–≤–∏–≥–∞—Ü–∏—è (–æ—á–µ–Ω—å –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è) #}
  <div class="contracts-breadcrumbs">
    <nav class="crumbs">
      <a href="{% url 'admin:index' %}">–ù–ê–ß–ê–õ–û</a>
      <span>‚Ä∫</span>
      <a href="{{ changelist_url }}">–î–û–ì–û–í–û–†–´</a>
      <span>‚Ä∫</span>
      <span class="crumbs-current">
        {% if add %}–ù–û–í–´–ô{% else %}{{ original.number|default:"–ë/–ù" }}{% endif %}
      </span>
    </nav>

    <span class="crumbs-note">
      {% if add %}—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏{% else %}—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏{% endif %}
    </span>
  </div>
{% endblock %}

{% block extrahead %}
  {{ block.super }}


  <style>
    /* ===== –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å ===== */
    .contracts-topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      padding:6px 0 8px;
      border-bottom:1px solid #e5e7eb;
      margin-bottom:10px;
    }
    .contracts-topbar__left{
      display:flex;
      align-items:flex-start;
      gap:12px;
      min-width:320px;
    }
    .contracts-icon{
      width:38px;height:38px;border-radius:10px;
      background:#0f172a;color:#e2e8f0;
      display:flex;align-items:center;justify-content:center;
      font-size:18px;font-weight:800;
      box-shadow:0 0 0 1px rgba(15,23,42,.18);
      flex:0 0 auto;
    }
    .contracts-kicker{
      font-size:11px;text-transform:uppercase;letter-spacing:.06em;color:#6b7280;
      line-height:1.1;
      margin-top:1px;
    }
    .contracts-title{
      font-size:18px;font-weight:750;color:#111827;
      line-height:1.15;
      margin-top:2px;
    }

    /* ===== –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç —Å–≤–µ—Ä—Ö—É ===== */
    .contracts-counterparty{
      margin-top:6px;
      font-size:13px;
      font-weight:800;
      color:#0f172a;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .contracts-counterparty::before{
      content:"–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:";
      font-size:11px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#6b7280;
    }

    .contracts-meta{
      display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;
    }
    .chip{
      font-size:11px;
      padding:2px 8px;
      border-radius:6px;
      font-weight:700;
      border:1px solid rgba(15,23,42,.10);
      background:#f8fafc;
      color:#334155;
    }
    .chip-blue{ background:#eff6ff; color:#1d4ed8; border-color:rgba(29,78,216,.12); }
    .chip-gray{ background:#f3f4f6; color:#4b5563; border-color:rgba(75,85,99,.12); }
    .chip-cyan{ background:#ecfeff; color:#155e75; border-color:rgba(21,94,117,.12); }

    .contracts-topbar__right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .link-btn{
      font-size:12px;
      padding:6px 10px;
      border-radius:10px;
      text-decoration:none;
      background:#eef2ff;
      color:#3730a3;
      border:1px solid rgba(55,48,163,.12);
    }
    .primary-btn{
      font-size:12px;
      padding:6px 10px;
      border-radius:10px;
      text-decoration:none;
      background:#e0f2fe;
      color:#075985;
      border:1px solid rgba(2,132,199,.18);
      font-weight:800;
    }
    .pill-btn{
      font-size:12px;
      padding:6px 10px;
      border-radius:6px;
      text-decoration:none;
      background:#f3f4f6;
      color:#374151;
      border:1px solid rgba(15,23,42,.10);
    }

    /* ===== –ö—Ä–æ—à–∫–∏ ===== */
    .contracts-breadcrumbs{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;
      margin:8px 0 0;
      padding-top:8px;
      color:#6b7280;
      font-size:11px;
    }
    .crumbs{ display:flex;align-items:center;gap:6px;flex-wrap:wrap; }
    .crumbs a{
      text-transform:uppercase;letter-spacing:.08em;
      text-decoration:none;color:#9ca3af;
    }
    .crumbs-current{
      text-transform:uppercase;letter-spacing:.08em;
      color:#4b5563;font-weight:800;
    }
    .crumbs-note{ color:#9ca3af; }

    /* ===== –ê–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º—ã ===== */
    #content-main .module { border-radius: 14px; overflow: hidden; }
    .submit-row { border-radius: 14px; }

    /* –°–¥–µ–ª–∞–µ–º —Ç–∞–±—ã/–∑–∞–≥–æ–ª–æ–≤–∫–∏ fieldset –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–µ (–µ—Å–ª–∏ —É —Ç–µ–±—è –æ–Ω–∏ –≤ –≤–∏–¥–µ –≤–∫–ª–∞–¥–æ–∫) */
    .tabs, .tablist, .tab-nav, ul.tabs, ul.tab-nav {
      border-radius: 14px;
    }

    /* –Ø–∫–æ—Ä—å –¥–ª—è —Ñ–∞–π–ª–æ–≤ */
    .inline-group { scroll-margin-top: 120px; }
  </style>
{% endblock %}

{% block content %}
  {{ block.super }}

  <script>
    // –Ø–∫–æ—Ä—å "–§–∞–π–ª—ã": –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ inline —Ñ–∞–π–ª–æ–≤ –∏ –≤—Å—Ç–∞–≤–∏—Ç—å <a id="contract-files">
    document.addEventListener('DOMContentLoaded', function () {
      if (document.getElementById('contract-files')) return;

      // 1) —Ç–≤–æ–π —Å—Ç–∞—Ä—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–µ—Å–ª–∏ id —Å–æ–≤–ø–∞–¥–∞–µ—Ç)
      let inline = document.getElementById('contractfiles_set-group');

      // 2) –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ inline (–º—è–≥–∫–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
      if (!inline) {
        const groups = document.querySelectorAll('.inline-group');
        groups.forEach(g => {
          const h2 = g.querySelector('h2, .inline-related h2, .module h2');
          const t = (h2 ? h2.textContent : '').toLowerCase();
          if (t.includes('contract files') || t.includes('files') || t.includes('—Ñ–∞–π–ª')) {
            inline = g;
          }
        });
      }

      if (inline) {
        const a = document.createElement('a');
        a.id = 'contract-files';
        inline.prepend(a);
      }

      // ===== –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç —Å–≤–µ—Ä—Ö—É: –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ –≤—ã–±–æ—Ä—É –ø–æ–ª—è cp =====
      const cpSelect = document.getElementById('id_cp');
      const cpTitle = document.getElementById('cpTitle');

      function updateCpTitle(){
        if (!cpSelect || !cpTitle) return;
        const option = cpSelect.options[cpSelect.selectedIndex];
        const txt = option ? option.text : '‚Äî';
        cpTitle.textContent = (cpSelect.value ? txt : '‚Äî');
      }

      if (cpSelect) {
        cpSelect.addEventListener('change', updateCpTitle);
        updateCpTitle();
      }
    });
  </script>
{% endblock %}
